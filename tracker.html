<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rami Job Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --background: #F7F8FC;
            --text-primary: #1A202C;
            --text-secondary: #4A5568;
            --brand-primary: #2563EB;
            --brand-secondary: #4F46E5;
            --card-bg: #FFFFFF;
            --border-color: #E2E8F0;
            --transition-speed: 0.3s;
            --transition-ease: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            scroll-behavior: smooth;
        }

        .main-container {
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            padding: 1rem 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0;
            margin-bottom: 3rem;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.05em;
        }

        .nav-link {
            font-weight: 600;
            color: var(--text-secondary);
            transition: all var(--transition-speed) var(--transition-ease);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }
        .nav-link:hover {
            color: var(--text-primary);
            background-color: #EDF2F7;
        }
        .nav-link.active {
            background-color: var(--brand-primary);
            color: white;
        }
        .nav-link.active:hover {
            background-color: #1D4ED8;
            color: white;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 2rem;
            text-align: center;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
            transition: transform var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease);
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07);
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--background);
            transition: all var(--transition-speed) var(--transition-ease);
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        .btn-primary {
            background-color: var(--brand-primary);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all var(--transition-speed) var(--transition-ease);
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #1D4ED8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all var(--transition-speed) var(--transition-ease);
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #CBD5E0;
            transform: translateY(-2px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            vertical-align: middle;
        }
        th.sortable {
            cursor: pointer;
            user-select: none;
        }
        th.sortable:hover {
            color: var(--text-primary);
        }
        th .sort-arrow {
            display: inline-block;
            margin-left: 0.25rem;
            opacity: 0.5;
            transition: opacity var(--transition-speed) var(--transition-ease);
        }
        th.sortable:hover .sort-arrow {
            opacity: 1;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        .status-applied { background-color: #DBEAFE; color: #1E40AF; }
        .status-interviewing { background-color: #FEF3C7; color: #92400E; }
        .status-offer { background-color: #D1FAE5; color: #065F46; }
        .status-rejected { background-color: #FEE2E2; color: #991B1B; }

        .ai-chat-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 4rem;
            height: 4rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            z-index: 40;
            background: linear-gradient(45deg, var(--brand-secondary), var(--brand-primary));
            color: white;
            transition: transform var(--transition-speed) var(--transition-ease);
            cursor: pointer;
        }
        .ai-chat-fab:hover {
            transform: scale(1.1);
        }

        .chat-popup {
            position: fixed;
            bottom: 7rem;
            right: 2rem;
            width: 90%;
            max-width: 400px;
            height: 60vh;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            z-index: 40;
            display: flex;
            flex-direction: column;
            transition: all var(--transition-speed) var(--transition-ease);
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
        }
        .chat-popup.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--brand-primary); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-section {
            animation: fade-in 0.8s var(--transition-ease) forwards;
        }
        
        .toast {
            background-color: var(--card-bg);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: toast-in 0.5s ease-out forwards, toast-out 0.5s ease-in 3s forwards;
        }
        @keyframes toast-in { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toast-out { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }

        #application-modal {
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-speed) var(--transition-ease);
        }
        #application-modal.is-visible {
            opacity: 1;
            pointer-events: auto;
        }
        #application-modal .card {
            transform: scale(0.95);
            transition: transform var(--transition-speed) var(--transition-ease);
        }
        #application-modal.is-visible .card {
            transform: scale(1);
        }

        .interviews-popup {
            position: fixed;
            top: 6rem;
            right: 2rem;
            width: 350px;
            background-color: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            z-index: 30;
            transition: all var(--transition-speed) var(--transition-ease);
            transform: translateX(120%);
            opacity: 0;
        }
        .interviews-popup.visible {
            transform: translateX(0);
            opacity: 1;
        }

    </style>
</head>
<body>
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3"></div>

    <div class="main-container">
        <header class="header">
            <div class="logo">Rami Tracker</div>
            <nav id="main-nav" class="hidden md:flex items-center space-x-1">
                <a href="#" class="nav-link active" data-view="main-view">Dashboard</a>
                <a href="#" class="nav-link" data-view="kanban-view">Board</a>
                <a href="#" class="nav-link" data-view="analytics-view">Analytics</a>
                <a href="#" class="nav-link" data-view="ai-tools-view">AI Tools</a>
                <a href="#" class="nav-link" data-view="documents-view">Documents</a>
                <a href="#" class="nav-link" data-view="achievements-view">Achievements</a>
            </nav>
            <div class="flex items-center gap-4">
                <button id="interviews-toggle-btn" class="relative text-gray-500 hover:text-gray-800 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <span id="interviews-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-4 h-4 rounded-full flex items-center justify-center hidden"></span>
                </button>
                <button id="add-app-cta" class="btn-primary">Add Application</button>
            </div>
        </header>

        <main id="main-view" class="fade-in-section">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <div id="stats-dashboard" class="lg:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                <div id="goal-tracker" class="card h-full"></div>
            </div>
            <div class="card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">All Applications</h2>
                    <input type="text" id="search-input" class="form-input w-full max-w-xs" placeholder="Search applications...">
                </div>
                <div class="overflow-x-auto">
                    <table id="applications-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Company <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="title">Job Title <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="date">Application Date <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="interviewDate">Interview Date <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort="status">Status <span class="sort-arrow"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="applications-table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <section id="kanban-view" class="hidden fade-in-section">
            <h1 class="section-title">Kanban Board</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </section>

        <section id="analytics-view" class="hidden fade-in-section">
            <h1 class="section-title">Analytics Dashboard</h1>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 text-center">Application Statuses</h2>
                    <canvas id="status-pie-chart" style="max-height: 350px;"></canvas>
                </div>
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 text-center">Application Timeline</h2>
                    <canvas id="timeline-bar-chart" style="max-height: 350px;"></canvas>
                </div>
            </div>
        </section>
        
        <section id="ai-tools-view" class="hidden fade-in-section">
            <h1 class="section-title">AI Powered Tools</h1>
            <div id="ai-tools-container"></div>
        </section>
        
        <section id="documents-view" class="hidden fade-in-section">
            <h1 class="section-title">My Documents</h1>
            <div id="documents-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8"></div>
        </section>

        <section id="achievements-view" class="hidden fade-in-section">
            <h1 class="section-title">My Achievements</h1>
            <div id="achievements-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6"></div>
        </section>

    </div>

    <!-- Upcoming Interviews Popup -->
    <div id="interviews-popup" class="interviews-popup">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="font-bold text-lg">Upcoming Interviews</h3>
            <button id="close-interviews-popup-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>
        <div id="interviews-popup-content" class="p-4 space-y-3"></div>
    </div>

    <!-- Add/Edit Application Modal -->
    <div id="application-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="card w-full max-w-2xl" id="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Application</h2>
            <form id="add-application-form" class="space-y-6">
                <input type="hidden" id="applicationId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="companyName" class="font-semibold mb-2 block">Company Name</label>
                        <input type="text" id="companyName" required class="form-input" placeholder="e.g., Google">
                    </div>
                    <div>
                        <label for="jobTitle" class="font-semibold mb-2 block">Job Title</label>
                        <input type="text" id="jobTitle" required class="form-input" placeholder="e.g., Software Engineer">
                    </div>
                </div>
                <div>
                    <label for="applicationLink" class="font-semibold mb-2 block">Application Link</label>
                    <input type="url" id="applicationLink" required class="form-input" placeholder="https://careers.google.com/...">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="applicationDate" class="font-semibold mb-2 block">Application Date</label>
                        <input type="date" id="applicationDate" required class="form-input">
                    </div>
                    <div>
                        <label for="status" class="font-semibold mb-2 block">Status</label>
                        <select id="status" class="form-select">
                            <option value="applied">Applied</option>
                            <option value="interviewing">Interviewing</option>
                            <option value="offer">Offer</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div>
                        <label for="interviewDate" class="font-semibold mb-2 block">Interview Date</label>
                        <input type="date" id="interviewDate" class="form-input">
                    </div>
                </div>
                <div>
                    <label for="notes" class="font-semibold mb-2 block">Notes</label>
                    <textarea id="notes" class="form-textarea" rows="4" placeholder="Any notes about this application..."></textarea>
                </div>
                <div class="flex justify-end items-center gap-4 mt-4">
                    <button type="button" id="delete-app-btn" class="font-semibold text-red-600 mr-auto hidden">Delete</button>
                    <button type="button" id="cancel-modal-btn" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Application</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AI Chat -->
    <button id="ai-chat-fab" class="ai-chat-fab">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15h14a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" />
        </svg>
    </button>
    <div id="chat-popup" class="chat-popup">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="font-bold text-lg">AI Assistant</h3>
            <button id="close-chat-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>
        <div id="chat-history" class="p-4 flex-grow overflow-y-auto space-y-4"></div>
        <div class="p-4 border-t">
            <div class="flex gap-2">
                <input type="text" id="chat-input" class="form-input flex-grow" placeholder="Ask anything...">
                <button id="send-chat-btn" class="btn-primary !p-3">Send</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const appDataKey = 'jobApplications_v6';
        const goalDataKey = 'weeklyGoal_v6';
        const achievementsDataKey = 'achievements_v6';
        const documentsDataKey = 'documents_v6';

        let applications = JSON.parse(localStorage.getItem(appDataKey)) || [
            { id: 1, name: 'SNRT', title: 'Technicien Spécialisé en Systèmes et Réseaux', link: '#', date: '2025-07-24', status: 'applied', notes: '', interviewDate: '' },
            { id: 2, name: 'SNRT', title: 'Technicien en Systèmes et Réseaux', link: '#', date: '2025-07-24', status: 'applied', notes: '', interviewDate: '' },
            { id: 3, name: 'Ensa Marrakesh', title: '1ere Cycle', link: '#', date: '2025-07-24', status: 'applied', notes: '', interviewDate: '2025-09-01' },
            { id: 4, name: 'Ancfcc', title: 'TS Réseaux', link: '#', date: '2025-07-21', status: 'applied', notes: '', interviewDate: '' },
            { id: 5, name: 'Ministère de la Santé', title: 'TECHNICIEN 3G', link: '#', date: '2025-07-20', status: 'applied', notes: '', interviewDate: '2025-09-14' },
            { id: 6, name: 'Ministère de la Justice', title: 'محرر قضائي من الدرجة الثالثة - سلم 9', link: '#', date: '2025-07-19', status: 'applied', notes: '', interviewDate: '2025-09-21' },
            { id: 7, name: 'Poste Maroc - Barid', title: 'Technicien Informatique', link: '#', date: '2025-07-17', status: 'applied', notes: '', interviewDate: '' },
            { id: 8, name: 'Cybersecurity - Dataprotect', title: 'formation en cybersécurité dispensée par le Cybersecurity Skills Lab de Dataprotect', link: '#', date: '2025-06-30', status: 'interviewing', notes: '', interviewDate: '2025-08-02' },
        ];
        let weeklyGoal = parseInt(localStorage.getItem(goalDataKey)) || 10;
        let achievements = JSON.parse(localStorage.getItem(achievementsDataKey)) || [];
        let documents = JSON.parse(localStorage.getItem(documentsDataKey)) || { pdf: null, text: [] };
        let currentSort = { key: 'date', direction: 'desc' };

        // --- DOM Elements ---
        const mainNav = document.getElementById('main-nav');
        const addAppCta = document.getElementById('add-app-cta');
        const applicationModal = document.getElementById('application-modal');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const deleteAppBtn = document.getElementById('delete-app-btn');
        const appForm = document.getElementById('add-application-form');
        const searchInput = document.getElementById('search-input');
        const toastContainer = document.getElementById('toast-container');
        const interviewsToggleBtn = document.getElementById('interviews-toggle-btn');
        const interviewsPopup = document.getElementById('interviews-popup');
        const closeInterviewsPopupBtn = document.getElementById('close-interviews-popup-btn');
        
        let statusPieChart = null;
        let timelineBarChart = null;

        // --- Data Persistence ---
        function saveApplications() { localStorage.setItem(appDataKey, JSON.stringify(applications)); checkAchievements(); }
        function saveGoal() { localStorage.setItem(goalDataKey, weeklyGoal); }
        function saveAchievements() { localStorage.setItem(achievementsDataKey, JSON.stringify(achievements)); }
        function saveDocuments() { localStorage.setItem(documentsDataKey, JSON.stringify(documents)); }

        // --- UI Helpers ---
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            const icon = type === 'success' ? '✅' : '❌';
            toast.innerHTML = `<span>${icon}</span><span class="font-semibold">${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        // --- Modal ---
        function openModal(app = null) {
            appForm.reset();
            deleteAppBtn.classList.add('hidden');
            if (app) {
                document.getElementById('modal-title').textContent = 'Edit Application';
                document.getElementById('applicationId').value = app.id;
                document.getElementById('companyName').value = app.name;
                document.getElementById('jobTitle').value = app.title;
                document.getElementById('applicationLink').value = app.link;
                document.getElementById('applicationDate').value = app.date;
                document.getElementById('status').value = app.status;
                document.getElementById('interviewDate').value = app.interviewDate || '';
                document.getElementById('notes').value = app.notes;
                deleteAppBtn.classList.remove('hidden');
            } else {
                document.getElementById('modal-title').textContent = 'Add New Application';
                document.getElementById('applicationId').value = '';
            }
            applicationModal.classList.add('is-visible');
        }
        function closeModal() { applicationModal.classList.remove('is-visible'); }
        addAppCta.addEventListener('click', () => openModal());
        cancelModalBtn.addEventListener('click', closeModal);
        applicationModal.addEventListener('click', (e) => { if (e.target === applicationModal) closeModal(); });
        deleteAppBtn.addEventListener('click', () => {
            const id = document.getElementById('applicationId').value;
            if (confirm('Are you sure you want to delete this application?')) {
                applications = applications.filter(a => a.id != id);
                saveApplications();
                renderAll();
                closeModal();
                showToast('Application deleted', 'error');
            }
        });

        // --- Form Submission ---
        appForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('applicationId').value;
            const appData = {
                name: document.getElementById('companyName').value,
                title: document.getElementById('jobTitle').value,
                link: document.getElementById('applicationLink').value,
                date: document.getElementById('applicationDate').value,
                status: document.getElementById('status').value,
                interviewDate: document.getElementById('interviewDate').value,
                notes: document.getElementById('notes').value,
            };
            const oldStatus = id ? applications.find(a => a.id == id).status : '';
            if (id) {
                const index = applications.findIndex(a => a.id == id);
                applications[index] = { ...applications[index], ...appData };
            } else {
                appData.id = Date.now();
                applications.unshift(appData);
            }
            if (oldStatus !== 'offer' && appData.status === 'offer') confetti();
            saveApplications();
            renderAll();
            closeModal();
            showToast('Application saved successfully!');
        });

        // --- View Rendering ---
        function renderAll() {
            const currentView = document.querySelector('.nav-link.active').dataset.view;
            renderUpcomingInterviewsPopup(); // Always render this to update badge
            switch(currentView) {
                case 'main-view': renderDashboard(); break;
                case 'kanban-view': renderKanbanBoard(); break;
                case 'analytics-view': renderAnalytics(); break;
                case 'ai-tools-view': renderAITools(); break;
                case 'documents-view': renderDocuments(); break;
                case 'achievements-view': renderAchievements(); break;
            }
        }

        function renderDashboard() {
            renderStats();
            renderGoalTracker();
            renderTable();
        }

        function renderStats() {
            const statsDashboard = document.getElementById('stats-dashboard');
            const stats = [
                { label: 'Total Apps', value: applications.length },
                { label: 'Interviewing', value: applications.filter(a => a.status === 'interviewing').length },
                { label: 'Offers', value: applications.filter(a => a.status === 'offer').length, color: 'text-green-500' },
            ];
            statsDashboard.innerHTML = stats.map(stat => `
                <div class="card text-center">
                    <p class="text-4xl font-bold ${stat.color || ''}">${stat.value}</p>
                    <p class="text-sm font-semibold text-gray-500 mt-1">${stat.label}</p>
                </div>
            `).join('');
        }

        function renderGoalTracker() {
            const goalTracker = document.getElementById('goal-tracker');
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - (startOfWeek.getDay() || 7) + 1);
            startOfWeek.setHours(0, 0, 0, 0);
            const appsThisWeek = applications.filter(app => new Date(app.date) >= startOfWeek).length;
            const progress = Math.min((appsThisWeek / weeklyGoal) * 100, 100);

            goalTracker.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">Weekly Goal</h3>
                    <div class="flex items-center gap-2">
                        <button id="goal-decrement" class="font-bold w-6 h-6 bg-gray-200 rounded-full">-</button>
                        <span class="font-bold">${weeklyGoal}</span>
                        <button id="goal-increment" class="font-bold w-6 h-6 bg-gray-200 rounded-full">+</button>
                    </div>
                </div>
                <div class="text-center mb-4">
                    <span class="text-4xl font-bold">${appsThisWeek}</span>
                    <span class="text-gray-500"> apps this week</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                </div>
            `;
            document.getElementById('goal-increment').addEventListener('click', () => { weeklyGoal++; saveGoal(); renderGoalTracker(); });
            document.getElementById('goal-decrement').addEventListener('click', () => { if (weeklyGoal > 1) { weeklyGoal--; saveGoal(); renderGoalTracker(); } });
        }
        
        function renderTable() {
            const tableBody = document.getElementById('applications-table-body');
            const query = searchInput.value.toLowerCase();
            let filteredApps = applications.filter(app =>
                app.name.toLowerCase().includes(query) || app.title.toLowerCase().includes(query)
            );

            // Sorting logic
            filteredApps.sort((a, b) => {
                let valA = a[currentSort.key] || '';
                let valB = b[currentSort.key] || '';
                if (currentSort.key === 'date' || currentSort.key === 'interviewDate') {
                    valA = valA ? new Date(valA) : 0;
                    valB = valB ? new Date(valB) : 0;
                }
                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            if (filteredApps.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-12">
                    <p class="text-lg font-semibold">No applications found!</p>
                    <p class="mt-1">Try adding a new application to get started.</p>
                </td></tr>`;
                return;
            }
            tableBody.innerHTML = filteredApps.map(app => `
                <tr class="hover:bg-gray-50">
                    <td class="font-bold">${app.name}</td>
                    <td>${app.title}</td>
                    <td>${new Date(app.date).toLocaleDateString()}</td>
                    <td>${app.interviewDate ? new Date(app.interviewDate).toLocaleDateString() : 'N/A'}</td>
                    <td><span class="status-badge status-${app.status}">${app.status}</span></td>
                    <td><button class="edit-btn p-2 rounded-md hover:bg-gray-200" data-id="${app.id}" title="Edit Application">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                    </button></td>
                </tr>
            `).join('');
            
            // Update sort arrows
            document.querySelectorAll('th.sortable .sort-arrow').forEach(arrow => arrow.innerHTML = '');
            const activeHeader = document.querySelector(`th[data-sort="${currentSort.key}"] .sort-arrow`);
            if (activeHeader) activeHeader.innerHTML = currentSort.direction === 'asc' ? '▲' : '▼';
        }
        
        document.getElementById('applications-table').querySelector('thead').addEventListener('click', (e) => {
            const header = e.target.closest('.sortable');
            if (header) {
                const key = header.dataset.sort;
                if (currentSort.key === key) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = key;
                    currentSort.direction = 'desc';
                }
                renderTable();
            }
        });

        document.getElementById('applications-table-body').addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            if(editBtn) {
                const appId = editBtn.dataset.id;
                const app = applications.find(a => a.id == appId);
                openModal(app);
            }
        });
        searchInput.addEventListener('input', renderTable);
        
        // --- Other Views (Kanban, Analytics, etc.) ---
        function renderKanbanBoard() {
            const kanbanContainer = document.querySelector('#kanban-view .grid');
            const statuses = ['applied', 'interviewing', 'offer', 'rejected'];
            const statusTitles = { applied: 'Applied', interviewing: 'Interviewing', offer: 'Offer', rejected: 'Rejected' };
            kanbanContainer.innerHTML = statuses.map(status => `
                <div class="kanban-column" data-status="${status}">
                    <h3 class="font-bold text-lg mb-4 text-gray-600">${statusTitles[status]} (${applications.filter(a => a.status === status).length})</h3>
                    <div class="space-y-3 min-h-[100px]">
                        ${applications.filter(app => app.status === status).map(app => `
                            <div class="kanban-card" draggable="true" data-id="${app.id}">
                                <p class="font-semibold">${app.name}</p>
                                <p class="text-sm text-gray-600">${app.title}</p>
                                ${app.interviewDate ? `<p class="text-xs text-red-600 font-semibold mt-2">Interview: ${new Date(app.interviewDate).toLocaleDateString()}</p>` : ''}
                            </div>`).join('')}
                    </div>
                </div>
            `).join('');
            let draggedCard = null;
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.addEventListener('dragstart', () => { draggedCard = card; setTimeout(() => card.classList.add('dragging'), 0); });
                card.addEventListener('dragend', () => { draggedCard.classList.remove('dragging'); draggedCard = null; });
            });
            document.querySelectorAll('.kanban-column .space-y-3').forEach(col => {
                col.addEventListener('dragover', e => e.preventDefault());
                col.addEventListener('drop', e => {
                    e.preventDefault();
                    const column = col.closest('.kanban-column');
                    const newStatus = column.dataset.status;
                    const appId = parseInt(draggedCard.dataset.id);
                    const app = applications.find(a => a.id == appId);
                    if (app && app.status !== newStatus) {
                        if(newStatus === 'offer') confetti();
                        app.status = newStatus;
                        saveApplications();
                        renderKanbanBoard();
                        renderDashboard();
                    }
                    col.appendChild(draggedCard);
                });
            });
        }

        function renderAnalytics() {
            if (statusPieChart) statusPieChart.destroy();
            if (timelineBarChart) timelineBarChart.destroy();
            const statusCounts = applications.reduce((acc, app) => { acc[app.status] = (acc[app.status] || 0) + 1; return acc; }, {});
            const pieCtx = document.getElementById('status-pie-chart').getContext('2d');
            statusPieChart = new Chart(pieCtx, { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#60A5FA', '#FBBF24', '#34D399', '#F87171'], borderColor: 'var(--card-bg)', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
            const weeklyData = applications.reduce((acc, app) => { const date = new Date(app.date); const weekStart = new Date(date.setDate(date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1))).toISOString().split('T')[0]; acc[weekStart] = (acc[weekStart] || 0) + 1; return acc; }, {});
            const sortedWeeks = Object.keys(weeklyData).sort();
            const barCtx = document.getElementById('timeline-bar-chart').getContext('2d');
            timelineBarChart = new Chart(barCtx, { type: 'bar', data: { labels: sortedWeeks, datasets: [{ label: 'Apps per Week', data: sortedWeeks.map(week => weeklyData[week]), backgroundColor: '#2563EB', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
        }

        function renderAITools() {
            const container = document.getElementById('ai-tools-container');
            container.innerHTML = `
                <div class="card">
                    <h3 class="text-2xl font-bold mb-6">Resume Analyzer</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="font-semibold mb-2 block">Job Description</label>
                            <textarea id="job-desc-input" class="form-textarea" rows="10" placeholder="Paste job description here..."></textarea>
                        </div>
                        <div>
                            <label class="font-semibold mb-2 block">Your Resume</label>
                            <select id="resume-selector" class="form-select mb-2"></select>
                            <textarea id="resume-input" class="form-textarea" rows="8" placeholder="Select a saved resume or paste here..."></textarea>
                        </div>
                    </div>
                    <button id="analyze-resume-btn" class="btn-primary mt-6">Analyze</button>
                    <div id="resume-analysis-result" class="mt-6 p-4 border rounded-lg bg-gray-50 hidden"></div>
                </div>
            `;
            const selector = document.getElementById('resume-selector');
            selector.innerHTML = '<option value="">Select a saved document...</option>';
            documents.text.forEach((doc, index) => { selector.innerHTML += `<option value="${index}">${doc.name}</option>`; });
            selector.addEventListener('change', (e) => { if (e.target.value) { document.getElementById('resume-input').value = documents.text[e.target.value].content; } });
            document.getElementById('analyze-resume-btn').addEventListener('click', async () => {
                const jobDesc = document.getElementById('job-desc-input').value;
                const resume = document.getElementById('resume-input').value;
                const resultDiv = document.getElementById('resume-analysis-result');
                if (!jobDesc || !resume) { resultDiv.innerHTML = '<p class="text-red-500">Please provide both a job description and a resume.</p>'; resultDiv.classList.remove('hidden'); return; }
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="spinner mx-auto"></div>';
                const prompt = `Analyze the following resume against the job description. Provide a match score from 1-100% and a list of key suggestions for improvement. Job Description: ${jobDesc}. Resume: ${resume}`;
                resultDiv.innerHTML = await callGemini(prompt);
            });
        }
        
        function renderDocuments() {
            const container = document.getElementById('documents-container');
            container.innerHTML = `
                <div class="card">
                    <h3 class="text-2xl font-bold mb-6">My PDF Resume</h3>
                    <input type="file" id="pdf-upload" accept="application/pdf" class="form-input">
                    <div id="pdf-viewer-container" class="mt-4 border rounded-lg h-96 bg-gray-100 flex items-center justify-center">
                        <embed id="pdf-viewer" type="application/pdf" width="100%" height="100%">
                        <p id="pdf-placeholder" class="text-gray-400">Upload a PDF to view it here</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-2xl font-bold mb-6">My Text Documents</h3>
                    <div id="text-documents-list" class="space-y-2 mb-4"></div>
                    <form id="add-text-document-form" class="space-y-4">
                        <input type="hidden" id="doc-id">
                        <input type="text" id="doc-name" placeholder="Document Name" required class="form-input">
                        <textarea id="doc-content" placeholder="Paste content here..." rows="5" class="form-textarea"></textarea>
                        <div class="flex gap-2">
                            <button type="submit" id="save-doc-btn" class="btn-primary">Save Document</button>
                            <button type="button" id="new-doc-btn" class="btn-secondary">New</button>
                        </div>
                    </form>
                </div>
            `;
            renderDocumentsList();
            document.getElementById('pdf-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') {
                    const reader = new FileReader();
                    reader.onload = (event) => { documents.pdf = event.target.result; saveDocuments(); renderDocuments(); };
                    reader.readAsDataURL(file);
                }
            });
            document.getElementById('add-text-document-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('doc-name').value;
                const content = document.getElementById('doc-content').value;
                const id = document.getElementById('doc-id').value;
                if (id) {
                    const doc = documents.text.find(d => d.id == id);
                    if (doc) { doc.name = name; doc.content = content; }
                } else {
                    documents.text.push({ id: Date.now(), name, content });
                }
                saveDocuments();
                renderDocumentsList();
                e.target.reset();
            });
            document.getElementById('new-doc-btn').addEventListener('click', () => document.getElementById('add-text-document-form').reset());
        }

        function renderDocumentsList() {
            const pdfViewer = document.getElementById('pdf-viewer');
            const pdfPlaceholder = document.getElementById('pdf-placeholder');
            if (documents.pdf) {
                pdfViewer.setAttribute('src', documents.pdf);
                pdfPlaceholder.classList.add('hidden');
            } else {
                pdfPlaceholder.classList.remove('hidden');
            }

            const list = document.getElementById('text-documents-list');
            list.innerHTML = documents.text.map(doc => `
                <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                    <p class="font-semibold cursor-pointer" data-id="${doc.id}">${doc.name}</p>
                    <button class="delete-doc-btn text-red-500 font-bold" data-id="${doc.id}">&times;</button>
                </div>
            `).join('') || '<p class="text-sm text-gray-500 text-center">No text documents saved.</p>';
            
            list.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                if (!id) return;
                if (e.target.classList.contains('delete-doc-btn')) {
                    documents.text = documents.text.filter(d => d.id != id);
                    saveDocuments();
                    renderDocumentsList();
                } else {
                    const doc = documents.text.find(d => d.id == id);
                    if (doc) {
                        document.getElementById('doc-id').value = doc.id;
                        document.getElementById('doc-name').value = doc.name;
                        document.getElementById('doc-content').value = doc.content;
                    }
                }
            });
        }

        function renderAchievements() {
            const grid = document.getElementById('achievements-grid');
            const achievementDefs = [
                { id: 'first_app', title: 'Getting Started', condition: () => applications.length >= 1 },
                { id: 'first_interview', title: 'First Interview', condition: () => applications.some(a => a.status === 'interviewing') },
                { id: 'first_offer', title: 'Job Offer!', condition: () => applications.some(a => a.status === 'offer') },
                { id: 'app_milestone_10', title: '10 Applications', condition: () => applications.length >= 10 },
                { id: 'app_milestone_25', title: '25 Applications', condition: () => applications.length >= 25 },
            ];
            grid.innerHTML = achievementDefs.map(def => {
                const unlocked = achievements.includes(def.id);
                return `<div class="card text-center ${unlocked ? 'border-2 border-green-400' : ''}"><p class="text-4xl mb-2">${unlocked ? '🏆' : '🔒'}</p><h4 class="font-bold">${def.title}</h4></div>`;
            }).join('');
        }

        function checkAchievements() {
            const achievementDefs = [
                { id: 'first_app', title: 'Getting Started', condition: () => applications.length >= 1 },
                { id: 'first_interview', title: 'First Interview', condition: () => applications.some(a => a.status === 'interviewing') },
                { id: 'first_offer', title: 'Job Offer!', condition: () => applications.some(a => a.status === 'offer') },
            ];
            achievementDefs.forEach(def => {
                if (!achievements.includes(def.id) && def.condition()) {
                    achievements.push(def.id);
                }
            });
            saveAchievements();
        }

        // --- AI Chat ---
        async function callGemini(prompt) {
            const apiKey = "YOUR_GEMINI_API_KEY"; // IMPORTANT: Replace with your key
            if (apiKey === "YOUR_GEMINI_API_KEY") return `<p class="text-red-500"><strong>API Key Not Configured.</strong><br>Please add your Gemini API key in the script to use AI features.</p>`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json();
                if (!response.ok) {
                    const errorMessage = data?.error?.message || `HTTP error! status: ${response.status}`;
                    throw new Error(`API Error: ${errorMessage}`);
                }
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    return data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                } else {
                    throw new Error("Invalid response structure from API.");
                }
            } catch (error) {
                console.error('Gemini API call failed:', error);
                return `<p class="text-red-500">Sorry, something went wrong. ${error.message}</p>`;
            }
        }
        const chatFab = document.getElementById('ai-chat-fab');
        const chatPopup = document.getElementById('chat-popup');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        chatFab.addEventListener('click', () => chatPopup.classList.toggle('visible'));
        closeChatBtn.addEventListener('click', () => chatPopup.classList.remove('visible'));
        sendChatBtn.addEventListener('click', handleChatSend);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChatSend(); });
        async function handleChatSend() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;
            appendChatMessage(userMessage, 'user');
            chatInput.value = '';
            appendChatMessage('', 'loading');
            const aiResponse = await callGemini(userMessage);
            const loadingMessage = chatHistory.querySelector('.loading-message');
            if (loadingMessage) loadingMessage.remove();
            appendChatMessage(aiResponse, 'ai');
        }
        function appendChatMessage(message, sender) {
            const wrapper = document.createElement('div');
            if (sender === 'loading') {
                wrapper.className = 'loading-message flex justify-start';
                wrapper.innerHTML = `<div class="p-3 rounded-lg bg-gray-200"><div class="spinner !w-5 !h-5 !border-2"></div></div>`;
            } else {
                wrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
                wrapper.innerHTML = `<div class="p-3 rounded-lg max-w-xs ${sender === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-200'}">${message}</div>`;
            }
            chatHistory.appendChild(wrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // --- Navigation ---
        mainNav.addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-link')) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                e.target.classList.add('active');
                const viewId = e.target.dataset.view;
                document.querySelectorAll('.main-container > main, .main-container > section').forEach(view => view.classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
                renderAll();
            }
        });

        // --- Upcoming Interviews Popup ---
        interviewsToggleBtn.addEventListener('click', () => {
            interviewsPopup.classList.toggle('visible');
        });
        closeInterviewsPopupBtn.addEventListener('click', () => {
            interviewsPopup.classList.remove('visible');
        });

        function renderUpcomingInterviewsPopup() {
            const badge = document.getElementById('interviews-badge');
            const content = document.getElementById('interviews-popup-content');
            const upcoming = applications
                .filter(app => app.status === 'interviewing' && app.interviewDate && new Date(app.interviewDate) >= new Date())
                .sort((a, b) => new Date(a.interviewDate) - new Date(b.interviewDate));

            if (upcoming.length > 0) {
                badge.textContent = upcoming.length;
                badge.classList.remove('hidden');
                content.innerHTML = upcoming.map(app => `
                    <div class="p-3 bg-gray-100 rounded-lg">
                        <p class="font-semibold">${app.name}</p>
                        <p class="text-sm text-gray-600">${new Date(app.interviewDate).toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                    </div>
                `).join('');
            } else {
                badge.classList.add('hidden');
                content.innerHTML = '<p class="text-sm text-center text-gray-500">No upcoming interviews.</p>';
            }
        }


        // --- Initial Load ---
        renderAll();
    });
    </script>
</body>
</html>